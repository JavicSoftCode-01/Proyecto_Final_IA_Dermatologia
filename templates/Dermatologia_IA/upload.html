{% extends "components/base.html" %}
{% load static %}

{% block title %}
  {{ page_title }}
{% endblock %}

{% block extra_css %}
  <!-- Cropper.js CSS -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.css"/>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <!-- Custom CSS -->
  <link rel="stylesheet" href="{% static 'css/upload.css' %}"/>
  <style>
      .upload-container {
          position: relative;
          display: block;
          width: 100%;
      }

      .upload-area {
          border: 2px dashed #ccc;
          padding: 20px;
          text-align: center;
          cursor: pointer;
          transition: border-color 0.3s ease;
          position: relative;
          z-index: 1;
          height: 13.5rem;
      }

      .upload-area:hover {
          border-color: #007bff;
      }

      .image-preview-container {
          position: absolute;
          top: -20px; /* Ajusta la distancia desde la parte superior del upload-area */
          left: 50%;
          transform: translateX(-50%);
          z-index: 2;
      }

      .image-preview {
          max-width: 224px;
          max-height: 224px;
          border: 1px solid #ddd;
          border-radius: 4px;
          cursor: pointer;
          transition: opacity 0.2s ease;
          display: none; /* Inicialmente oculto, se muestra con JavaScript */
      }

      .image-preview:hover {
          opacity: 0.8;
      }

      .img-container {
          display: flex;
          justify-content: center;
          align-items: center;
          height: 400px; /* Modal más grande */
          overflow: hidden;
      }

      #imageToCrop {
          max-width: 90%;
          max-height: 90%;
          object-fit: contain; /* Asegura que la imagen se ajuste sin distorsión */
      }

      /* Personalizar el tamaño del modal */
      .custom-modal .modal-dialog {
          max-width: 750px; /* Modal más ancho */
      }
  </style>
{% endblock %}

{% block content %}
  <div class="container mt-4">
    <div class="card p-4">
      <h1 class="text-center mb-4">{{ upload_section.title }}</h1>

      <form
              id="uploadForm"
              enctype="multipart/form-data"
              method="post"
              data-search-url="{% url 'dermatology:search_patients' %}"
              data-submit-url="{% url 'dermatology:upload_image' %}"
      >
        {% csrf_token %}

        <!-- Patient Selection -->
        <div id="section-select-patient" class="mb-4">
          <label class="form-label">{{ upload_section.patient_search.label }}</label>
          <div class="patient-select-container">
            <select
                    class="form-select"
                    name="patient"
                    id="patient_select"
                    aria-label="Buscar paciente por cédula"
            >
              <option value="">
                {{ upload_section.patient_search.select_placeholder }}
              </option>
              {% for patient in patients %}
                <option
                        value="{{ patient.id }}"
                        data-first="{{ patient.first_name }}"
                        data-last="{{ patient.last_name }}"
                        data-dni="{{ patient.dni }}"
                        data-phone="{{ patient.phone|default:'' }}"
                        data-email="{{ patient.email|default:'' }}"
                        data-age="{{ patient.age_approx }}"
                        data-sex="{{ patient.sex }}"
                >
                  {{ patient.dni }} - {{ patient.first_name }} {{ patient.last_name }}
                </option>
              {% endfor %}
            </select>
            <div class="typing-hint">
              {{ upload_section.patient_search.typing_hint }}
            </div>
          </div>
          <div class="mt-3">
            <button type="button" class="btn btn-success" id="btn-add-new">
              {{ upload_section.new_patient.button_text }}
            </button>
          </div>
        </div>

        <!-- Image Upload with Cropping -->
        <div id="section-upload">
          <div class="mb-4">
            <label class="form-label">{{ upload_section.image_upload.title }}</label>
            <div class="upload-container">
              <div class="upload-area" id="uploadArea">
                <i class="bi bi-cloud-arrow-up fs-1"></i>
                <h4 class="mt-3">{{ upload_section.image_upload.instructions }}</h4>
                <p class="text-muted">{{ upload_section.image_upload.formats }}</p>
                <input
                        type="file"
                        id="fileInput"
                        name="image"
                        accept="image/*"
                        style="display: none"
                        required
                />
              </div>
              <div class="image-preview-container">
                <img
                        id="imagePreview"
                        class="image-preview"
                        src="#"
                        alt="{{ upload_section.image_upload.preview_alt }}"
                />
              </div>
            </div>
            <div
                    id="fileError"
                    class="alert alert-danger mt-2"
                    style="display: none"
            ></div>
          </div>

          <!-- Location Selection -->
          <div class="mb-4">
            <label class="form-label">{{ upload_section.location.label }}</label>
            <select
                    id="site_select"
                    name="anatom_site_general"
                    class="form-select"
                    required
            >
              <option value="">{{ upload_section.location.placeholder }}</option>
              {% for code, display in form.anatom_site_general.field.choices %}
                <option value="{{ code }}">{{ display }}</option>
              {% endfor %}
            </select>
            <div
                    id="siteError"
                    class="alert alert-danger mt-2"
                    style="display: none"
            ></div>
          </div>
        </div>

        <!-- New Patient Fields -->
        <div id="section-patient-fields" class="patient-form">
          <h4 class="mb-3">{{ upload_section.new_patient.title }}</h4>
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="first_name" class="form-label">
                {{ upload_section.new_patient.labels.first_name }}
              </label>
              <input
                      type="text"
                      id="first_name"
                      name="first_name"
                      class="form-control mb-2"
                      placeholder="{{ upload_section.new_patient.labels.first_name }}"
              />
            </div>
            <div class="col-md-6 mb-3">
              <label for="last_name" class="form-label">
                {{ upload_section.new_patient.labels.last_name }}
              </label>
              <input
                      type="text"
                      id="last_name"
                      name="last_name"
                      class="form-control mb-2"
                      placeholder="{{ upload_section.new_patient.labels.last_name }}"
              />
            </div>
          </div>
          <div class="row">
            <div class="col-md-4 mb-3">
              <label for="dni" class="form-label">
                {{ upload_section.new_patient.labels.dni }}
              </label>
              <input
                      type="text"
                      id="dni"
                      name="dni"
                      class="form-control mb-2"
                      placeholder="{{ upload_section.new_patient.labels.dni }}"
              />
            </div>
            <div class="col-md-4 mb-3">
              <label for="phone" class="form-label">
                {{ upload_section.new_patient.labels.phone }}
              </label>
              <input
                      type="text"
                      id="phone"
                      name="phone"
                      class="form-control mb-2"
                      placeholder="{{ upload_section.new_patient.labels.phone }}"
              />
            </div>
            <div class="col-md-4 mb-3">
              <label for="email" class="form-label">
                {{ upload_section.new_patient.labels.email }}
              </label>
              <input
                      type="email"
                      id="email"
                      name="email"
                      class="form-control mb-2"
                      placeholder="{{ upload_section.new_patient.labels.email }}"
              />
            </div>
          </div>
          <div class="row mb-3">
            <div class="col-md-4">
              <label for="age_approx" class="form-label">
                {{ upload_section.new_patient.labels.age_approx }}
              </label>
              <input
                      type="number"
                      id="age_approx"
                      name="age_approx"
                      class="form-control mb-2"
                      min="0"
                      max="120"
              />
            </div>
            <div class="col-md-4">
              <label for="sex" class="form-label">
                {{ upload_section.new_patient.labels.sex }}
              </label>
              <select id="sex" name="sex" class="form-select mb-2">
                <option value="">
                  {{ upload_section.new_patient.sex_placeholder }}
                </option>
                {% for value, display_name in sex_choices %}
                  <option value="{{ value }}">{{ display_name }}</option>
                {% endfor %}
              </select>
            </div>
          </div>
        </div>

        <!-- Error Alert -->
        <div
                id="errorAlert"
                class="alert alert-danger"
                style="display: none"
        ></div>

        <!-- Submit Button -->
        <div class="d-grid gap-2 mt-4">
          <button
                  type="submit"
                  class="btn {{ buttons.submit.class }}"
                  id="analyzeBtn"
          >
            {{ buttons.submit.text }}
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Crop Modal -->
  <div class="modal fade custom-modal" id="cropModal" tabindex="-1" aria-labelledby="cropModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="cropModalLabel">Recortar Imagen a 224x224 PX de Dimención</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="img-container">
            <img id="imageToCrop" src="#" alt="Image to crop"/>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="button" class="btn btn-primary" id="cropButton">Recortar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Loading Overlay -->
  <div class="loading-overlay" id="loadingOverlay" style="display: none">
    <div class="loading-container">
      <div class="spinner-border text-light" role="status">
        <span class="visually-hidden">{{ loading.spinner_alt }}</span>
      </div>
      <div class="loading-text">
        <p>{{ loading.message }}</p>
        <p class="small text-muted">{{ loading.submessage }}</p>
      </div>
    </div>
  </div>
{% endblock %}

{% block extra_js %}
  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <!-- Cropper.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.js"></script>
  <!-- Existing upload.js -->
  <script src="{% static 'js/upload.js' %}"></script>

  <script>
    document.addEventListener("DOMContentLoaded", function () {
      // Pass JS texts from Django context
      const JS_TEXTS = {
        searchingPrefix: "{{ js_texts.searching_prefix|escapejs }}",
        searchPlaceholderDefault: "{{ js_texts.search_placeholder_default|escapejs }}",
        errorSearchingPatients: "{{ js_texts.error_searching_patients|escapejs }}",
        validation: {
          emptyField: "{{ js_texts.validation_errors.empty_field|escapejs }}",
          nameMinLength: "{{ js_texts.validation_errors.name_min_length|escapejs }}",
          nameMaxLength: "{{ js_texts.validation_errors.name_max_length|escapejs }}",
          nameRegex: "{{ js_texts.validation_errors.name_regex|escapejs }}",
          dniExactLength: "{{ js_texts.validation_errors.dni_exact_length|escapejs }}",
          dniNumeric: "{{ js_texts.validation_errors.dni_numeric|escapejs }}",
          dniInvalid: "{{ js_texts.validation_errors.dni_invalid|escapejs }}",
          emailMaxLength: "{{ js_texts.validation_errors.email_max_length|escapejs }}",
          emailInvalid: "{{ js_texts.validation_errors.email_invalid|escapejs }}",
          phoneInvalidFormat: "{{ js_texts.validation_errors.phone_invalid_format|escapejs }}",
          ageInvalid: "{{ js_texts.validation_errors.age_invalid|escapejs }}",
          imageRequired: "{{ js_texts.validation_errors.image_required|escapejs }}",
          imageInvalidType: "{{ js_texts.validation_errors.image_invalid_type|escapejs }}",
          imageMaxSize: "{{ js_texts.validation_errors.image_max_size|escapejs }}",
          siteRequired: "{{ js_texts.validation_errors.site_required|escapejs }}",
        },
        generalErrors: {
          formErrors: "{{ error_messages_general.form_errors|escapejs }}",
          serverError: "{{ error_messages_general.server_error|escapejs }}",
        },
      };

      // Initialize upload manager
      initializeUpload(JS_TEXTS);

      // Variables para el cropper
      let cropper;
      let isFileInputTriggered = false;

      // Referencias a elementos
      const uploadArea = document.getElementById('uploadArea');
      const fileInput = document.getElementById('fileInput');
      const imagePreview = document.getElementById('imagePreview');
      const cropModal = document.getElementById('cropModal');
      const imageToCrop = document.getElementById('imageToCrop');
      const cropButton = document.getElementById('cropButton');

      // Evento click del área de upload para abrir explorador de archivos
      uploadArea.addEventListener('click', function (e) {
        // Prevenir que se dispare múltiples veces
        if (isFileInputTriggered) return;

        // Marcar que se está disparando el input
        isFileInputTriggered = true;

        // Disparar el input de archivo
        fileInput.click();

        // Reset la bandera después de un pequeño delay
        setTimeout(() => {
          isFileInputTriggered = false;
        }, 100);
      });

      // Evento click en la imagen de vista previa para abrir el modal de crop
      imagePreview.addEventListener('click', function (e) {
        if (imagePreview.style.display !== 'none' && fileInput.files && fileInput.files.length > 0) {
          const file = fileInput.files[0];
          const reader = new FileReader();
          reader.onload = function (e) {
            imageToCrop.src = e.target.result;
            const modal = new bootstrap.Modal(cropModal);
            modal.show();
          };
          reader.readAsDataURL(file);
        }
      });

      // Manejar la selección de archivos
      fileInput.addEventListener('change', function (e) {
        const file = e.target.files[0];

        if (!file) {
          // Si no hay archivo, resetear todo
          imagePreview.style.display = 'none';
          imagePreview.src = '#';
          return;
        }

        // Validar tipo de archivo
        if (!file.type.startsWith('image/')) {
          alert('Por favor selecciona un archivo de imagen válido.');
          fileInput.value = '';
          return;
        }

        // Validar tamaño de archivo (ejemplo: 10MB máximo)
        const maxSize = 10 * 1024 * 1024; // 10MB
        if (file.size > maxSize) {
          alert('El archivo es demasiado grande. Máximo 10MB.');
          fileInput.value = '';
          return;
        }

        // Mostrar preview inmediato de la imagen original
        const reader = new FileReader();
        reader.onload = function (e) {
          imagePreview.src = e.target.result;
          imagePreview.style.display = 'block';

          // Abrir modal de crop automáticamente solo si es una nueva selección
          imageToCrop.src = e.target.result;
          const modal = new bootstrap.Modal(cropModal);
          modal.show();
        };

        reader.onerror = function () {
          alert('Error al leer el archivo. Por favor intenta nuevamente.');
          fileInput.value = '';
          imagePreview.style.display = 'none';
        };

        reader.readAsDataURL(file);
      });

      // Inicializar cropper cuando se muestra el modal
      cropModal.addEventListener('shown.bs.modal', function () {
        // Destruir cropper anterior si existe
        if (cropper) {
          cropper.destroy();
          cropper = null;
        }

        // Crear nuevo cropper con tamaño fijo de 224x224
        cropper = new Cropper(imageToCrop, {
          aspectRatio: 1,
          viewMode: 1,
          minCropBoxWidth: 224,
          minCropBoxHeight: 224,
          maxCropBoxWidth: 224,
          maxCropBoxHeight: 224,
          cropBoxResizable: false,
          cropBoxMovable: true,
          dragMode: 'move',
          responsive: true,
          restore: false,
          guides: true,
          center: true,
          highlight: true,
          background: true,
          autoCrop: true,
          autoCropArea: 0.8,
          ready: function () {
            console.log('Cropper inicializado correctamente');
          }
        });
      });

      // Manejar el botón de crop
      cropButton.addEventListener('click', function () {
        if (!cropper) {
          alert('Error: El cropper no está inicializado.');
          return;
        }

        try {
          // Obtener el canvas con la imagen recortada
          const canvas = cropper.getCroppedCanvas({
            width: 224,
            height: 224,
            imageSmoothingEnabled: true,
            imageSmoothingQuality: 'high'
          });

          if (!canvas) {
            alert('Error al procesar la imagen. Por favor intenta nuevamente.');
            return;
          }

          // Convertir a blob
          canvas.toBlob(function (blob) {
            if (!blob) {
              alert('Error al generar la imagen recortada.');
              return;
            }

            // Crear un nuevo archivo con el blob
            const croppedFile = new File([blob], 'cropped-image.jpg', {
              type: 'image/jpeg',
              lastModified: Date.now()
            });

            // Actualizar el input de archivo
            const dataTransfer = new DataTransfer();
            dataTransfer.items.add(croppedFile);
            fileInput.files = dataTransfer.files;

            // Mostrar preview
            const previewUrl = URL.createObjectURL(blob);
            imagePreview.src = previewUrl;
            imagePreview.style.display = 'block';

            // Cerrar el modal
            const modal = bootstrap.Modal.getInstance(cropModal);
            modal.hide();

            console.log('Imagen recortada exitosamente');
          }, 'image/jpeg', 0.9);

        } catch (error) {
          console.error('Error al procesar la imagen:', error);
          alert('Error al procesar la imagen. Por favor intenta nuevamente.');
        }
      });

      // Limpiar cropper cuando se cierra el modal
      cropModal.addEventListener('hidden.bs.modal', function () {
        if (cropper) {
          cropper.destroy();
          cropper = null;
        }
      });

      // Manejar el caso cuando se cancela el modal
      cropModal.addEventListener('hidden.bs.modal', function (e) {
        // Si se cerró el modal sin hacer crop, mantener la imagen original
        // Solo limpiar si no hay ninguna imagen previa
        if (!imagePreview.src || imagePreview.src === window.location.href + '#') {
          fileInput.value = '';
          imagePreview.style.display = 'none';
        }
      });

      // Prevenir comportamientos no deseados en el área de upload
      uploadArea.addEventListener('dragover', function (e) {
        e.preventDefault();
        uploadArea.style.borderColor = '#007bff';
      });

      uploadArea.addEventListener('dragleave', function (e) {
        e.preventDefault();
        uploadArea.style.borderColor = '#ccc';
      });

      uploadArea.addEventListener('drop', function (e) {
        e.preventDefault();
        uploadArea.style.borderColor = '#ccc';

        const files = e.dataTransfer.files;
        if (files.length > 0) {
          fileInput.files = files;
          // Disparar el evento change manualmente
          const event = new Event('change', {bubbles: true});
          fileInput.dispatchEvent(event);
        }
      });
    });
  </script>
{% endblock %}
