{% extends "components/base.html" %}
{% load static %}

{% block title %}{{ page_title }}{% endblock %}

{% block extra_css %}
  <style>
      .error-message {
          color: #dc3545;
          font-size: 0.875em;
          margin-top: 0.25rem;
      }

      .warning-message {
          color: #ffc107;
          font-size: 0.875em;
          margin-top: 0.25rem;
      }

      .form-control.error {
          border-color: #dc3545;
      }

      .form-control.warning {
          border-color: #ffc107;
      }

      .loading-overlay {
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(0, 0, 0, 0.7);
          display: none;
          justify-content: center;
          align-items: center;
          z-index: 9999;
      }

      .loading-container {
          text-align: center;
          color: white;
      }

      .upload-area {
          border: 2px dashed #ccc;
          border-radius: 8px;
          padding: 2rem;
          text-align: center;
          cursor: pointer;
          transition: all 0.3s ease;
      }

      .image-preview {
          max-width: 100%;
          max-height: 300px;
          margin-top: 1rem;
      }

      .patient-form {
          display: none;
          border: 1px solid #e9ecef;
          border-radius: 8px;
          padding: 1.5rem;
          background-color: #f8f9fa;
          animation: slideDown 0.3s ease-out;
      }

      @keyframes slideDown {
          from {
              opacity: 0;
              transform: translateY(-10px);
          }
          to {
              opacity: 1;
              transform: translateY(0);
          }
      }

      .patient-select-container {
          position: relative;
      }

      #patient_select {
          cursor: text;
          user-select: text;
      }

      #patient_select:focus {
          border-color: #007bff;
          box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
      }

      #patient_select:focus::after {
          content: '';
          position: absolute;
          right: 10px;
          top: 50%;
          transform: translateY(-50%);
          width: 2px;
          height: 18px;
          background-color: #007bff;
          animation: blink 1s infinite;
      }

      @keyframes blink {
          0%, 50% {
              opacity: 1;
          }
          51%, 100% {
              opacity: 0;
          }
      }

      #patient_select option {
          padding: 8px 12px;
      }

      #patient_select option:first-child {
          font-style: italic;
          color: #6c757d;
      }

      #btn-add-new {
          transition: all 0.3s ease;
      }

      #btn-add-new:hover {
          transform: translateY(-1px);
          box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
      }

      input[readonly], select[disabled] {
          background-color: #e9ecef !important;
          cursor: not-allowed;
      }

      .typing-hint {
          font-size: 0.75rem;
          color: #6c757d;
          margin-top: 0.25rem;
          font-style: italic;
      }

      .searching-indicator {
          position: absolute;
          right: 10px;
          top: 50%;
          transform: translateY(-50%);
          font-size: 0.75rem;
          color: #007bff;
      }

      .searching-indicator::after {
          content: 'üîÑ';
          animation: spin 1s linear infinite;
      }

      @keyframes spin {
          100% {
              transform: rotate(360deg);
          }
      }
  </style>
{% endblock %}

{% block content %}
  <div class="container mt-4">
    <div class="card p-4">
      <h1 class="text-center mb-4">{{ upload_section.title }}</h1>

      <form id="uploadForm" enctype="multipart/form-data" method="post">
        {% csrf_token %}

        <div id="section-select-patient" class="mb-4">
          <label class="form-label">{{ upload_section.patient_search.label }}</label>
          <div class="patient-select-container">
            <select class="form-select" name="patient" id="patient_select" aria-label="Buscar paciente por c√©dula">
              <option value="">{{ upload_section.patient_search.select_placeholder }}</option>
              {% for patient in patients %}
                <option value="{{ patient.id }}"
                        data-first="{{ patient.first_name }}"
                        data-last="{{ patient.last_name }}"
                        data-dni="{{ patient.dni }}"
                        data-phone="{{ patient.phone|default:'' }}"
                        data-email="{{ patient.email|default:'' }}"
                        data-age="{{ patient.age_approx }}"
                        data-sex="{{ patient.sex }}">
                  {{ patient.dni }} - {{ patient.first_name }} {{ patient.last_name }}
                </option>
              {% endfor %}
            </select>
            <div class="typing-hint">{{ upload_section.patient_search.typing_hint }}</div>
          </div>
          <div class="mt-3">
            <button type="button" class="btn btn-success" id="btn-add-new">
              {{ upload_section.new_patient.button_text }}
            </button>
          </div>
        </div>

        <div id="section-upload">
          <div class="mb-4">
            <label class="form-label">{{ upload_section.image_upload.title }}</label>
            <div class="upload-area" id="uploadArea">
              <i class="bi bi-cloud-arrow-up fs-1"></i>
              <h4 class="mt-3">{{ upload_section.image_upload.instructions }}</h4>
              <p class="text-muted">{{ upload_section.image_upload.formats }}</p>
              <input type="file" id="fileInput" name="image" accept="image/*" class="d-none" required>
              <img id="imagePreview" class="image-preview" src="#" alt="{{ upload_section.image_upload.preview_alt }}"
                   style="display:none;">
            </div>
            <div id="fileError" class="alert alert-danger mt-2" style="display:none;"></div>
          </div>

          <div class="mb-4">
            <label class="form-label">{{ upload_section.location.label }}</label>
            <select id="site_select" name="anatom_site_general" class="form-select" required>
              <option value="">{{ upload_section.location.placeholder }}</option>
              {% for code, display in form.anatom_site_general.field.choices %}
                <option value="{{ code }}">{{ display }}</option>
              {% endfor %}
            </select>
            <div id="siteError" class="alert alert-danger mt-2" style="display:none;"></div>
          </div>
        </div>

        <div id="section-patient-fields" class="patient-form">
          <h4 class="mb-3">{{ upload_section.new_patient.title }}</h4>
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="first_name" class="form-label">{{ upload_section.new_patient.labels.first_name }}</label>
              <input type="text" id="first_name" name="first_name" class="form-control mb-2"
                     placeholder="{{ upload_section.new_patient.labels.first_name }}">
            </div>
            <div class="col-md-6 mb-3">
              <label for="last_name" class="form-label">{{ upload_section.new_patient.labels.last_name }}</label>
              <input type="text" id="last_name" name="last_name" class="form-control mb-2"
                     placeholder="{{ upload_section.new_patient.labels.last_name }}">
            </div>
          </div>
          <div class="row">
            <div class="col-md-4 mb-3">
              <label for="dni" class="form-label">{{ upload_section.new_patient.labels.dni }}</label>
              <input type="text" id="dni" name="dni" class="form-control mb-2"
                     placeholder="{{ upload_section.new_patient.labels.dni }}">
            </div>
            <div class="col-md-4 mb-3">
              <label for="phone" class="form-label">{{ upload_section.new_patient.labels.phone }}</label>
              <input type="text" id="phone" name="phone" class="form-control mb-2"
                     placeholder="{{ upload_section.new_patient.labels.phone }}">
            </div>
            <div class="col-md-4 mb-3">
              <label for="email" class="form-label">{{ upload_section.new_patient.labels.email }}</label>
              <input type="email" id="email" name="email" class="form-control mb-2"
                     placeholder="{{ upload_section.new_patient.labels.email }}">
            </div>
          </div>
          <div class="row mb-3">
            <div class="col-md-4">
              <label for="age_approx" class="form-label">{{ upload_section.new_patient.labels.age_approx }}</label>
              <input type="number" id="age_approx" name="age_approx" class="form-control mb-2" min="0" max="120">
            </div>
            <div class="col-md-4">
              <label for="sex" class="form-label">{{ upload_section.new_patient.labels.sex }}</label>
              <select id="sex" name="sex" class="form-select mb-2">
                <option value="">{{ upload_section.new_patient.sex_placeholder }}</option>
                {% for value, display_name in sex_choices %}
                  <option value="{{ value }}">{{ display_name }}</option>
                {% endfor %}
              </select>
            </div>
          </div>
        </div>

        <div id="errorAlert" class="alert alert-danger" style="display:none;"></div>

        <div class="d-grid gap-2 mt-4">
          <button type="submit" class="btn {{ buttons.submit.class }}" id="analyzeBtn">
            {{ buttons.submit.text }}
          </button>
        </div>
      </form>
    </div>
  </div>

  <div class="loading-overlay" id="loadingOverlay" style="display:none;">
    <div class="loading-container">
      <div class="spinner-border text-light" role="status">
        <span class="visually-hidden">{{ loading.spinner_alt }}</span>
      </div>
      <div class="loading-text">
        <p>{{ loading.message }}</p>
        <p class="small text-muted">{{ loading.submessage }}</p>
      </div>
    </div>
  </div>

  {% block extra_js %}
    <script>
      // Pasar textos de JS desde el contexto de Django
      const JS_TEXTS = {
        searchingPrefix: "{{ js_texts.searching_prefix|escapejs }}",
        searchPlaceholderDefault: "{{ js_texts.search_placeholder_default|escapejs }}",
        errorSearchingPatients: "{{ js_texts.error_searching_patients|escapejs }}",
        validation: {
          emptyField: "{{ js_texts.validation_errors.empty_field|escapejs }}",
          nameMinLength: "{{ js_texts.validation_errors.name_min_length|escapejs }}",
          nameMaxLength: "{{ js_texts.validation_errors.name_max_length|escapejs }}",
          nameRegex: "{{ js_texts.validation_errors.name_regex|escapejs }}",
          dniExactLength: "{{ js_texts.validation_errors.dni_exact_length|escapejs }}",
          dniNumeric: "{{ js_texts.validation_errors.dni_numeric|escapejs }}",
          dniInvalid: "{{ js_texts.validation_errors.dni_invalid|escapejs }}",
          emailMaxLength: "{{ js_texts.validation_errors.email_max_length|escapejs }}",
          emailInvalid: "{{ js_texts.validation_errors.email_invalid|escapejs }}",
          phoneInvalidFormat: "{{ js_texts.validation_errors.phone_invalid_format|escapejs }}",
          ageInvalid: "{{ js_texts.validation_errors.age_invalid|escapejs }}",
          imageRequired: "{{ js_texts.validation_errors.image_required|escapejs }}",
          imageInvalidType: "{{ js_texts.validation_errors.image_invalid_type|escapejs }}",
          imageMaxSize: "{{ js_texts.validation_errors.image_max_size|escapejs }}",
          siteRequired: "{{ js_texts.validation_errors.site_required|escapejs }}"
        },
        generalErrors: {
          formErrors: "{{ error_messages_general.form_errors|escapejs }}",
          serverError: "{{ error_messages_general.server_error|escapejs }}"
        }
      };

      document.addEventListener('DOMContentLoaded', function () {
        const patientSelect = document.getElementById('patient_select');
        const btnAddNew = document.getElementById('btn-add-new');
        const sectionPatientFields = document.getElementById('section-patient-fields');
        const fileInput = document.getElementById('fileInput');
        const uploadArea = document.getElementById('uploadArea');
        const imagePreview = document.getElementById('imagePreview');
        const siteSelect = document.getElementById('site_select');
        const uploadForm = document.getElementById('uploadForm');
        const loadingOverlay = document.getElementById('loadingOverlay');
        const errorAlert = document.getElementById('errorAlert');
        // const fileError = document.getElementById('fileError'); // Ya no se usa directamente, se usa createErrorMessage
        // const siteError = document.getElementById('siteError'); // Ya no se usa directamente
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

        const firstNameInput = document.getElementById('first_name');
        const lastNameInput = document.getElementById('last_name');
        const dniInput = document.getElementById('dni');
        const phoneInput = document.getElementById('phone');
        const emailInput = document.getElementById('email');
        const ageInput = document.getElementById('age_approx');
        const sexSelect = document.getElementById('sex');

        const initialOptions = Array.from(patientSelect.options).map(option => ({
          value: option.value, text: option.textContent,
          first: option.dataset.first, last: option.dataset.last, dni: option.dataset.dni,
          phone: option.dataset.phone, email: option.dataset.email, age: option.dataset.age, sex: option.dataset.sex
        }));

        let currentPatients = [...initialOptions];
        let searchTimeout = null;
        let isTyping = false;
        let typingValue = '';
        let lastSelectedValue = '';

        function updatePatientOptions(patients, selectedValue = '') {
          patientSelect.innerHTML = `<option value="">${JS_TEXTS.searchPlaceholderDefault}</option>`;
          patients.forEach(patient => {
            if (patient.value) {
              const option = document.createElement('option');
              option.value = patient.value;
              option.textContent = patient.text;
              Object.keys(patient).forEach(key => {
                if (key !== 'value' && key !== 'text' && patient[key] !== undefined) {
                  option.dataset[key] = patient[key];
                }
              });
              if (patient.value === selectedValue) option.selected = true;
              patientSelect.appendChild(option);
            }
          });
        }

        function restoreInitialOptions(selectedValue = '') {
          currentPatients = [...initialOptions].sort((a, b) => (b.value && a.value) ? parseInt(b.value) - parseInt(a.value) : 0);
          updatePatientOptions(currentPatients, selectedValue);
        }

        function convertServerDataToOptions(serverPatients) {
          return serverPatients.map(patient => ({
            value: patient.id.toString(),
            text: `${patient.dni} - ${patient.first_name} ${patient.last_name}`,
            first: patient.first_name, last: patient.last_name, dni: patient.dni,
            phone: patient.phone, email: patient.email, age: patient.age_approx, sex: patient.sex
          }));
        }

        function searchPatients(query) {
          if (searchTimeout) clearTimeout(searchTimeout);
          searchTimeout = setTimeout(() => {
            const currentSelected = patientSelect.value;
            if (!query.trim()) {
              restoreInitialOptions(currentSelected);
              patientSelect.options[0].textContent = JS_TEXTS.searchPlaceholderDefault;
              return;
            }
            // Usar la URL nombrada para search_patients
            fetch(`{% url 'dermatology:search_patients' %}?dni=${encodeURIComponent(query)}`)
              .then(res => res.json())
              .then(data => {
                const newPatients = convertServerDataToOptions(data.patients);
                if (currentSelected) {
                  const selectedOption = initialOptions.find(p => p.value === currentSelected);
                  if (selectedOption && !newPatients.find(p => p.value === currentSelected)) {
                    newPatients.unshift(selectedOption);
                  }
                }
                currentPatients = newPatients;
                updatePatientOptions(currentPatients, currentSelected);
                patientSelect.options[0].textContent = `${JS_TEXTS.searchingPrefix} ${query}`;
              })
              .catch(err => {
                console.error(JS_TEXTS.errorSearchingPatients, err);
                errorAlert.textContent = `${JS_TEXTS.errorSearchingPatients} ${err.message}`;
                errorAlert.style.display = 'block';
              });
          }, 300);
        }

        patientSelect.addEventListener('keydown', function (e) {
          if (e.key.length === 1 && !/^[0-9]$/.test(e.key)) {
            e.preventDefault();
            return;
          }
          if (typingValue.length >= 10 && e.key.length === 1) {
            e.preventDefault();
            return;
          }
          if (e.key.length === 1 || e.key === 'Backspace' || e.key === 'Delete') {
            isTyping = true;
            if (e.key === 'Backspace') typingValue = typingValue.slice(0, -1);
            else if (e.key === 'Delete') typingValue = '';
            else if (e.key.length === 1) typingValue += e.key;
            const placeholder = this.options[0];
            placeholder.textContent = typingValue ? `${JS_TEXTS.searchingPrefix} ${typingValue}` : JS_TEXTS.searchPlaceholderDefault;
            searchPatients(typingValue);
            e.preventDefault();
          } else if (e.key === 'Enter') {
            e.preventDefault();
            if (this.options.length === 2) {
              this.selectedIndex = 1;
              this.dispatchEvent(new Event('change'));
              isTyping = false;
              typingValue = '';
              this.options[0].textContent = JS_TEXTS.searchPlaceholderDefault;
              restoreInitialOptions(this.value);
            }
          } else if (e.key === 'Escape') {
            isTyping = false;
            typingValue = '';
            this.options[0].textContent = JS_TEXTS.searchPlaceholderDefault;
            restoreInitialOptions(this.value);
          } else if (e.key === 'ArrowDown' || e.key === 'ArrowUp') {
            if (!isTyping) restoreInitialOptions(this.value);
          }
        });

        patientSelect.addEventListener('change', function () {
          const selected = this.selectedOptions[0];
          lastSelectedValue = this.value;
          if (selected && selected.value) {
            sectionPatientFields.style.display = 'block';
            firstNameInput.value = selected.dataset.first;
            lastNameInput.value = selected.dataset.last;
            dniInput.value = selected.dataset.dni;
            phoneInput.value = selected.dataset.phone;
            emailInput.value = selected.dataset.email;
            ageInput.value = selected.dataset.age;
            sexSelect.value = selected.dataset.sex;
            [firstNameInput, lastNameInput, dniInput, phoneInput, emailInput, ageInput, sexSelect]
              .forEach(el => {
                el.setAttribute('readonly', true);
                el.disabled = true;
                removeErrorMessage(el);
              });
            isTyping = false;
            typingValue = '';
            this.options[0].textContent = JS_TEXTS.searchPlaceholderDefault;
            updatePatientOptions(currentPatients, this.value);
          } else {
            sectionPatientFields.style.display = 'none';
            isTyping = false;
            typingValue = '';
            this.options[0].textContent = JS_TEXTS.searchPlaceholderDefault;
            restoreInitialOptions();
          }
        });

        patientSelect.addEventListener('focus', function () {
          if (!isTyping) restoreInitialOptions(lastSelectedValue);
          else if (typingValue) this.options[0].textContent = `${JS_TEXTS.searchingPrefix} ${typingValue}`;
        });
        patientSelect.addEventListener('click', function () {
          if (!isTyping && !typingValue) {
            restoreInitialOptions(lastSelectedValue);
            this.options[0].textContent = JS_TEXTS.searchPlaceholderDefault;
          }
        });
        patientSelect.addEventListener('blur', function () {
          if (!this.value && !typingValue) {
            isTyping = false;
            this.options[0].textContent = JS_TEXTS.searchPlaceholderDefault;
            restoreInitialOptions();
          } else if (typingValue) {
            this.options[0].textContent = `${JS_TEXTS.searchingPrefix} ${typingValue}`;
          }
        });

        btnAddNew.addEventListener('click', function () {
          sectionPatientFields.style.display = 'block';
          [firstNameInput, lastNameInput, dniInput, phoneInput, emailInput, ageInput, sexSelect]
            .forEach(el => {
              el.value = '';
              el.removeAttribute('readonly');
              el.disabled = false;
              removeErrorMessage(el);
            });
          patientSelect.value = '';
          lastSelectedValue = '';
          isTyping = false;
          typingValue = '';
          patientSelect.options[0].textContent = JS_TEXTS.searchPlaceholderDefault;
          restoreInitialOptions();
        });

        restoreInitialOptions();

        function createErrorMessage(input, message, isWarning = false) {
          removeErrorMessage(input);
          const errorDiv = document.createElement('div');
          errorDiv.className = isWarning ? 'warning-message' : 'error-message';
          errorDiv.textContent = message;
          const parent = input.id === 'fileInput' ? input.closest('.upload-area').parentNode : input.parentNode;
          parent.appendChild(errorDiv);
          input.classList.add(isWarning ? 'warning' : 'error');
        }

        function removeErrorMessage(input) {
          const parent = input.id === 'fileInput' ? input.closest('.upload-area').parentNode : input.parentNode;
          const errorMsg = parent.querySelector('.error-message, .warning-message');
          if (errorMsg) errorMsg.remove();
          input.classList.remove('error', 'warning');
        }

        function validateFullName(value) {
          const trimmedValue = value.trim();
          if (!trimmedValue) return JS_TEXTS.validation.emptyField;
          if (trimmedValue.length < 3) return JS_TEXTS.validation.nameMinLength;
          if (trimmedValue.length > 50) return JS_TEXTS.validation.nameMaxLength;
          if (!/^[a-zA-Z√°√©√≠√≥√∫√Å√â√ç√ì√ö√±√ë\s]+$/.test(trimmedValue)) return JS_TEXTS.validation.nameRegex;
          return null;
        }

        function validateDni(value) {
          const trimmedValue = value.trim();
          if (!trimmedValue) return {message: JS_TEXTS.validation.emptyField, isWarning: false};
          if (trimmedValue.length !== 10) return {message: JS_TEXTS.validation.dniExactLength, isWarning: false};
          if (!/^\d+$/.test(trimmedValue)) return {message: JS_TEXTS.validation.dniNumeric, isWarning: false};
          const coeficientes = [2, 1, 2, 1, 2, 1, 2, 1, 2];
          let total = 0;
          for (let i = 0; i < 9; i++) {
            let valor = parseInt(trimmedValue[i]) * coeficientes[i];
            if (valor > 9) valor -= 9;
            total += valor;
          }
          const digitoVerificador = (total % 10) === 0 ? 0 : 10 - (total % 10);
          if (digitoVerificador !== parseInt(trimmedValue[9])) return {
            message: JS_TEXTS.validation.dniInvalid,
            isWarning: false
          };
          return null;
        }

        function validateEmail(value) {
          const trimmedValue = value.trim();
          if (!trimmedValue) return JS_TEXTS.validation.emptyField;
          if (trimmedValue.length > 254) return JS_TEXTS.validation.emailMaxLength;
          if (!/^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/.test(trimmedValue)) return JS_TEXTS.validation.emailInvalid;
          return null;
        }

        function validatePhone(value) {
          const trimmedValue = value.trim();
          if (!trimmedValue) return JS_TEXTS.validation.emptyField;
          if (!/^(\+593\s\d{2}\s\d{3}\s\d{4}|0\d{9})$/.test(trimmedValue)) return JS_TEXTS.validation.phoneInvalidFormat;
          return null;
        }

        function validateAge(value) {
          if (!value) return JS_TEXTS.validation.emptyField;
          const age = parseInt(value);
          if (isNaN(age) || age < 0 || age > 120) return JS_TEXTS.validation.ageInvalid;
          return null;
        }

        function validateImage(file) {
          if (!file) return JS_TEXTS.validation.imageRequired;
          const validTypes = ['image/jpeg', 'image/png', 'image/jpg'];
          if (!validTypes.includes(file.type)) return JS_TEXTS.validation.imageInvalidType;
          if (file.size > 5 * 1024 * 1024) return JS_TEXTS.validation.imageMaxSize;
          return null;
        }

        uploadArea.addEventListener('click', () => fileInput.click());
        uploadArea.addEventListener('dragover', e => {
          e.preventDefault();
          uploadArea.style.borderColor = '#007bff';
          uploadArea.style.backgroundColor = '#f8fbff';
        });
        uploadArea.addEventListener('dragleave', () => {
          uploadArea.style.borderColor = '#ccc';
          uploadArea.style.backgroundColor = '';
        });
        uploadArea.addEventListener('drop', e => {
          e.preventDefault();
          uploadArea.style.borderColor = '#ccc';
          uploadArea.style.backgroundColor = '';
          if (e.dataTransfer.files.length) {
            const file = e.dataTransfer.files[0];
            const error = validateImage(file);
            if (error) createErrorMessage(fileInput, error);
            else {
              removeErrorMessage(fileInput);
              fileInput.files = e.dataTransfer.files;
              previewImage(file);
            }
          }
        });

        fileInput.addEventListener('change', () => {
          if (fileInput.files.length) {
            const file = fileInput.files[0];
            const error = validateImage(file);
            if (error) createErrorMessage(fileInput, error);
            else {
              removeErrorMessage(fileInput);
              previewImage(file);
            }
          }
        });

        function previewImage(file) {
          const reader = new FileReader();
          reader.onload = e => {
            imagePreview.src = e.target.result;
            imagePreview.style.display = 'block';
          };
          reader.readAsDataURL(file);
        }

        uploadForm.addEventListener('submit', function (e) {
          e.preventDefault();
          let hasErrors = false;
          errorAlert.style.display = 'none';
          errorAlert.textContent = ''; // Limpiar errores previos

          // Limpiar todos los mensajes de error de campos individuales
          [firstNameInput, lastNameInput, dniInput, phoneInput, emailInput, ageInput, sexSelect, fileInput, siteSelect].forEach(removeErrorMessage);


          if (!patientSelect.value) { // Solo validar campos de nuevo paciente si no se seleccion√≥ uno existente
            const firstNameError = validateFullName(firstNameInput.value);
            if (firstNameError) {
              createErrorMessage(firstNameInput, firstNameError);
              hasErrors = true;
            }
            const lastNameError = validateFullName(lastNameInput.value);
            if (lastNameError) {
              createErrorMessage(lastNameInput, lastNameError);
              hasErrors = true;
            }
            const dniResult = validateDni(dniInput.value);
            if (dniResult) {
              createErrorMessage(dniInput, dniResult.message, dniResult.isWarning);
              if (!dniResult.isWarning) hasErrors = true;
            }
            const phoneError = validatePhone(phoneInput.value);
            if (phoneError) {
              createErrorMessage(phoneInput, phoneError);
              hasErrors = true;
            }
            const emailError = validateEmail(emailInput.value);
            if (emailError) {
              createErrorMessage(emailInput, emailError);
              hasErrors = true;
            }
            const ageError = validateAge(ageInput.value);
            if (ageError) {
              createErrorMessage(ageInput, ageError);
              hasErrors = true;
            }
            if (!sexSelect.value) {
              createErrorMessage(sexSelect, JS_TEXTS.validation.emptyField);
              hasErrors = true;
            }
          }

          const imageError = validateImage(fileInput.files[0]);
          if (imageError) {
            createErrorMessage(fileInput, imageError);
            hasErrors = true;
          }
          if (!siteSelect.value) {
            createErrorMessage(siteSelect, JS_TEXTS.validation.siteRequired);
            hasErrors = true;
          }

          if (hasErrors) {
            errorAlert.textContent = JS_TEXTS.generalErrors.formErrors;
            errorAlert.style.display = 'block';
            return;
          }

          loadingOverlay.style.display = 'flex';
          const formData = new FormData();

          if (patientSelect.value) {
            formData.append('patient', patientSelect.value);
          } else {
            formData.append('first_name', firstNameInput.value);
            formData.append('last_name', lastNameInput.value);
            formData.append('dni', dniInput.value);
            formData.append('phone', phoneInput.value);
            formData.append('email', emailInput.value);
            formData.append('age_approx', ageInput.value);
            formData.append('sex', sexSelect.value);
          }
          formData.append('image', fileInput.files[0]);
          formData.append('anatom_site_general', siteSelect.value);
          // CSRF token ya no se a√±ade aqu√≠, se env√≠a con el form.

          fetch("{% url 'dermatology:upload_image' %}", {
            method: 'POST',
            body: formData,
            headers: {'X-CSRFToken': csrfToken}
          })
            .then(res => {
              if (!res.ok) {
                return res.json().then(data => {
                  const errorDetail = data.errors || {general: `Error: ${res.status}`};
                  throw {status: res.status, data: errorDetail};
                });
              }
              return res.json();
            })
            .then(data => {
              if (data.success && data.redirect_url) {
                window.location.href = data.redirect_url;
              } else { // Esto no deber√≠a ocurrir si la respuesta fue ok y success true
                throw {data: data.errors || {general: JS_TEXTS.generalErrors.serverError}};
              }
            })
            .catch(errObj => {
              loadingOverlay.style.display = 'none';
              let errorMessage = JS_TEXTS.generalErrors.serverError;
              if (errObj && errObj.data) {
                // Mostrar errores espec√≠ficos de campos si est√°n disponibles
                Object.keys(errObj.data).forEach(key => {
                  const field = document.getElementById(key) || (key === 'image' ? fileInput : null) || (key === 'anatom_site_general' ? siteSelect : null);
                  const message = Array.isArray(errObj.data[key]) ? errObj.data[key].join(', ') : errObj.data[key];
                  if (field) {
                    createErrorMessage(field, message);
                  } else if (key === 'general' || key === '__all__') {
                    errorMessage = message;
                  } else {
                    // Si hay un error no asociado a un campo espec√≠fico, a√±adirlo al error general
                    errorMessage += ` ${key}: ${message}`;
                  }
                });
              } else if (errObj && errObj.message) {
                errorMessage = errObj.message;
              }
              errorAlert.textContent = errorMessage;
              errorAlert.style.display = 'block';
            });
        });
      });
    </script>
  {% endblock %}
{% endblock %}