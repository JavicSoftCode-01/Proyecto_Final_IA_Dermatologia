{% extends "components/base.html" %}
{% load static %}

{% block title %}{{ page_title }}{% endblock %}

{% block extra_css %}
  <style>
      .error-message {
          color: #dc3545;
          font-size: 0.875em;
          margin-top: 0.25rem;
      }

      .warning-message {
          color: #ffc107;
          font-size: 0.875em;
          margin-top: 0.25rem;
      }

      .form-control.error {
          border-color: #dc3545;
      }

      .form-control.warning {
          border-color: #ffc107;
      }

      .loading-overlay {
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(0, 0, 0, 0.7);
          display: none;
          justify-content: center;
          align-items: center;
          z-index: 9999;
      }

      .loading-container {
          text-align: center;
          color: white;
      }

      .upload-area {
          border: 2px dashed #ccc;
          border-radius: 8px;
          padding: 2rem;
          text-align: center;
          cursor: pointer;
          transition: all 0.3s ease;
      }

      .image-preview {
          max-width: 100%;
          max-height: 300px;
          margin-top: 1rem;
      }

      .patient-form {
          display: none;
      }

      /* Estilos adicionales para el select de pacientes mejorado */
      .patient-select-container {
          position: relative;
      }

      #patient_select {
          cursor: text;
          user-select: text;
      }

      #patient_select:focus {
          border-color: #007bff;
          box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
      }

      /* Indicador visual de que se puede escribir */
      #patient_select:focus::after {
          content: '';
          position: absolute;
          right: 10px;
          top: 50%;
          transform: translateY(-50%);
          width: 2px;
          height: 18px;
          background-color: #007bff;
          animation: blink 1s infinite;
      }

      @keyframes blink {
          0%, 50% {
              opacity: 1;
          }
          51%, 100% {
              opacity: 0;
          }
      }

      /* Estilo para las opciones del select */
      #patient_select option {
          padding: 8px 12px;
      }

      #patient_select option:first-child {
          font-style: italic;
          color: #6c757d;
      }

      /* Estilo para el bot√≥n de nuevo paciente */
      #btn-add-new {
          transition: all 0.3s ease;
      }

      #btn-add-new:hover {
          transform: translateY(-1px);
          box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
      }

      /* Mejoras visuales para el formulario de paciente */
      .patient-form {
          border: 1px solid #e9ecef;
          border-radius: 8px;
          padding: 1.5rem;
          background-color: #f8f9fa;
          animation: slideDown 0.3s ease-out;
      }

      @keyframes slideDown {
          from {
              opacity: 0;
              transform: translateY(-10px);
          }
          to {
              opacity: 1;
              transform: translateY(0);
          }
      }

      /* Indicador de campo readonly */
      input[readonly], select[disabled] {
          background-color: #e9ecef !important;
          cursor: not-allowed;
      }

      /* Tooltip para indicar funcionalidad de escritura */
      .typing-hint {
          font-size: 0.75rem;
          color: #6c757d;
          margin-top: 0.25rem;
          font-style: italic;
      }

      /* Estilo para mostrar cuando se est√° buscando */
      .searching-indicator {
          position: absolute;
          right: 10px;
          top: 50%;
          transform: translateY(-50%);
          font-size: 0.75rem;
          color: #007bff;
      }

      .searching-indicator::after {
          content: 'üîÑ';
          animation: spin 1s linear infinite;
      }

      @keyframes spin {
          100% {
              transform: rotate(360deg);
          }
      }
  </style>
{% endblock %}

{% block content %}
  <div class="container mt-4">
    <div class="card p-4">
      <h1 class="text-center mb-4">{{ upload_section.title }}</h1>

      <form id="uploadForm" enctype="multipart/form-data" method="post">
        {% csrf_token %}

        <!-- Patient Selection -->
        <!-- Solo la secci√≥n del select de pacientes mejorada -->
        <div id="section-select-patient" class="mb-4">
          <label class="form-label">{{ upload_section.patient_search.label }}</label>
          <div class="patient-select-container">
            {#            <select class="form-select" name="patient" id="patient_select">#}
            <select class="form-select" name="patient" id="patient_select" aria-label="Buscar paciente por c√©dula">
              <option value="">Busque por c√©dula (solo n√∫meros, m√°x. 10)</option>
              {% for patient in patients %}
                <option value="{{ patient.id }}"
                        data-first="{{ patient.first_name }}"
                        data-last="{{ patient.last_name }}"
                        data-dni="{{ patient.dni }}"
                        data-phone="{{ patient.phone|default:'' }}"
                        data-email="{{ patient.email|default:'' }}"
                        data-age="{{ patient.age_approx }}"
                        data-sex="{{ patient.sex }}">
                  {{ patient.dni }} - {{ patient.first_name }} {{ patient.last_name }}
                </option>
              {% endfor %}
            </select>
            <div class="typing-hint">
              üí° Haga clic y escriba la c√©dula (solo n√∫meros, m√°ximo 10 d√≠gitos)
            </div>
          </div>
          <div class="mt-3">
            <button type="button" class="btn btn-success" id="btn-add-new">
              {{ upload_section.new_patient.button_text }}
            </button>
          </div>
        </div>

        <!-- Image Upload and Anatomical Location -->
        <div id="section-upload">
          <div class="mb-4">
            <label class="form-label">{{ upload_section.image_upload.title }}</label>
            <div class="upload-area" id="uploadArea">
              <i class="bi bi-cloud-arrow-up fs-1"></i>
              <h4 class="mt-3">{{ upload_section.image_upload.instructions }}</h4>
              <p class="text-muted">{{ upload_section.image_upload.formats }}</p>
              <input type="file"
                     id="fileInput"
                     name="image"
                     accept="image/*"
                     class="d-none"
                     required>
              <img id="imagePreview"
                   class="image-preview"
                   src="#"
                   alt="{{ upload_section.image_upload.preview_alt }}"
                   style="display:none;">
            </div>
            <div id="fileError" class="alert alert-danger mt-2" style="display:none;"></div>
          </div>

          <div class="mb-4">
            <label class="form-label">{{ upload_section.location.label }}</label>
            <select id="site_select"
                    name="anatom_site_general"
                    class="form-select"
                    required>
              <option value="">{{ upload_section.location.placeholder }}</option>
              {% for code, display in form.anatom_site_general.field.choices %}
                <option value="{{ code }}">{{ display }}</option>
              {% endfor %}
            </select>
            <div id="siteError" class="alert alert-danger mt-2" style="display:none;"></div>
          </div>
        </div>

        <!-- Patient Form -->
        <div id="section-patient-fields" class="patient-form">
          <h4 class="mb-3">{{ upload_section.new_patient.title }}</h4>
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="first_name" class="form-label">Nombre</label>
              <input type="text" id="first_name" name="first_name" class="form-control mb-2" placeholder="Nombre">
            </div>
            <div class="col-md-6 mb-3">
              <label for="last_name" class="form-label">Apellido</label>
              <input type="text" id="last_name" name="last_name" class="form-control mb-2" placeholder="Apellido">
            </div>
          </div>
          <div class="row">
            <div class="col-md-4 mb-3">
              <label for="dni" class="form-label">DNI</label>
              <input type="text" id="dni" name="dni" class="form-control mb-2" placeholder="DNI">
            </div>
            <div class="col-md-4 mb-3">
              <label for="phone" class="form-label">Tel√©fono</label>
              <input type="text" id="phone" name="phone" class="form-control mb-2" placeholder="Tel√©fono">
            </div>
            <div class="col-md-4 mb-3">
              <label for="email" class="form-label">Correo Electr√≥nico</label>
              <input type="email" id="email" name="email" class="form-control mb-2" placeholder="Correo electr√≥nico">
            </div>
          </div>
          <div class="row mb-3">
            <div class="col-md-4">
              <label for="age_approx" class="form-label">Edad Aproximada</label>
              <input type="number" id="age_approx" name="age_approx" class="form-control mb-2" min="0" max="120">
            </div>
            <div class="col-md-4">
              <label for="sex" class="form-label">Sexo</label>
              <select id="sex" name="sex" class="form-select mb-2">
                <option value="">-- Seleccionar --</option>
                <option value="female">Femenino</option>
                <option value="male">Masculino</option>
                <option value="unknown">Desconocido</option>
              </select>
            </div>
          </div>
        </div>

        <!-- Error Messages -->
        <div id="errorAlert" class="alert alert-danger" style="display:none;"></div>

        <!-- Submit Button -->
        <div class="d-grid gap-2 mt-4">
          <button type="submit" class="btn {{ buttons.submit.class }}" id="analyzeBtn">
            {{ buttons.submit.text }}
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Loading Overlay -->
  <div class="loading-overlay" id="loadingOverlay" style="display:none;">
    <div class="loading-container">
      <div class="spinner-border text-light" role="status">
        <span class="visually-hidden">Cargando...</span>
      </div>
      <div class="loading-text">
        <p>{{ loading.message }}</p>
        <p class="small text-muted">{{ loading.submessage }}</p>
      </div>
    </div>
  </div>

  {% block extra_js %}
    <script>
      document.addEventListener('DOMContentLoaded', function () {
        const patientSelect = document.getElementById('patient_select');
        const btnAddNew = document.getElementById('btn-add-new');
        const sectionPatientFields = document.getElementById('section-patient-fields');
        const fileInput = document.getElementById('fileInput');
        const uploadArea = document.getElementById('uploadArea');
        const imagePreview = document.getElementById('imagePreview');
        const siteSelect = document.getElementById('site_select');
        const uploadForm = document.getElementById('uploadForm');
        const loadingOverlay = document.getElementById('loadingOverlay');
        const errorAlert = document.getElementById('errorAlert');
        const fileError = document.getElementById('fileError');
        const siteError = document.getElementById('siteError');
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

        const firstNameInput = document.getElementById('first_name');
        const lastNameInput = document.getElementById('last_name');
        const dniInput = document.getElementById('dni');
        const phoneInput = document.getElementById('phone');
        const emailInput = document.getElementById('email');
        const ageInput = document.getElementById('age_approx');
        const sexSelect = document.getElementById('sex');

        // Store initial patient options
        const initialOptions = Array.from(patientSelect.options).map(option => ({
          value: option.value,
          text: option.textContent,
          first: option.dataset.first,
          last: option.dataset.last,
          dni: option.dataset.dni,
          phone: option.dataset.phone,
          email: option.dataset.email,
          age: option.dataset.age,
          sex: option.dataset.sex
        }));

        let currentPatients = [...initialOptions]; // Keep track of current patients
        let searchTimeout = null;
        let isTyping = false;
        let typingValue = '';
        let lastSelectedValue = ''; // Track the last selected patient

        // Function to update patient options
        function updatePatientOptions(patients, selectedValue = '') {
          patientSelect.innerHTML = '<option value="">Busque por c√©dula (solo n√∫meros, m√°x. 10)</option>';
          patients.forEach(patient => {
            if (patient.value) { // Skip placeholder option
              const option = document.createElement('option');
              option.value = patient.value;
              option.textContent = patient.text;
              option.dataset.first = patient.first;
              option.dataset.last = patient.last;
              option.dataset.dni = patient.dni;
              option.dataset.phone = patient.phone;
              option.dataset.email = patient.email;
              option.dataset.age = patient.age;
              option.dataset.sex = patient.sex;
              if (patient.value === selectedValue) option.selected = true;
              patientSelect.appendChild(option);
            }
          });
        }

        // Function to restore initial options (sorted by most recent)
        function restoreInitialOptions(selectedValue = '') {
          currentPatients = [...initialOptions].sort((a, b) => b.value - a.value); // Sort by ID descending (most recent first)
          updatePatientOptions(currentPatients, selectedValue);
        }

        // Convert server response to our format
        function convertServerDataToOptions(serverPatients) {
          return serverPatients.map(patient => ({
            value: patient.id.toString(),
            text: `${patient.dni} - ${patient.first_name} ${patient.last_name}`,
            first: patient.first_name,
            last: patient.last_name,
            dni: patient.dni,
            phone: patient.phone,
            email: patient.email,
            age: patient.age_approx,
            sex: patient.sex
          }));
        }

        // Enhanced patient search with typing support
        function searchPatients(query) {
          if (searchTimeout) {
            clearTimeout(searchTimeout);
          }

          searchTimeout = setTimeout(() => {
            const currentSelected = patientSelect.value;

            if (!query.trim()) {
              restoreInitialOptions(currentSelected);
              patientSelect.options[0].textContent = 'Busque por c√©dula (solo n√∫meros, m√°x. 10)';
              return;
            }

            fetch(`/dermatology/search-patients/?dni=${encodeURIComponent(query)}`)
              .then(res => res.json())
              .then(data => {
                const newPatients = convertServerDataToOptions(data.patients);

                // Include the selected patient in the list if it exists
                if (currentSelected) {
                  const selectedOption = initialOptions.find(p => p.value === currentSelected);
                  if (selectedOption && !newPatients.find(p => p.value === currentSelected)) {
                    newPatients.unshift(selectedOption);
                  }
                }

                currentPatients = newPatients;
                updatePatientOptions(currentPatients, currentSelected);
                patientSelect.options[0].textContent = `Buscando: ${query}`;
              })
              .catch(err => {
                console.error('Error searching patients:', err);
                errorAlert.textContent = 'Error al buscar pacientes: ' + err.message;
                errorAlert.style.display = 'block';
              });
          }, 300); // 300ms delay for better UX
        }

        // Make the select editable for typing
        patientSelect.addEventListener('keydown', function (e) {
          // Only allow numbers, backspace, delete, and control keys
          if (e.key.length === 1 && !/^[0-9]$/.test(e.key)) {
            e.preventDefault();
            return;
          }
          if (typingValue.length >= 10 && e.key.length === 1) {
            e.preventDefault();
            return;
          }

          // Handle typing
          if (e.key.length === 1 || e.key === 'Backspace' || e.key === 'Delete') {
            isTyping = true;
            if (e.key === 'Backspace') {
              typingValue = typingValue.slice(0, -1);
            } else if (e.key === 'Delete') {
              typingValue = '';
            } else if (e.key.length === 1) {
              typingValue += e.key;
            }

            // Update the placeholder to show what's being typed
            const placeholder = this.options[0];
            placeholder.textContent = typingValue ? `Buscando: ${typingValue}` : 'Busque por c√©dula (solo n√∫meros, m√°x. 10)';

            // Trigger search
            searchPatients(typingValue);

            // Prevent default select behavior
            e.preventDefault();
          } else if (e.key === 'Enter') {
            e.preventDefault();
            // If there's only one option besides placeholder, select it
            if (this.options.length === 2) {
              this.selectedIndex = 1;
              this.dispatchEvent(new Event('change'));
              // Reset typing state
              isTyping = false;
              typingValue = '';
              this.options[0].textContent = 'Busque por c√©dula (solo n√∫meros, m√°x. 10)';
              restoreInitialOptions(this.value);
            }
          } else if (e.key === 'Escape') {
            // Reset search
            isTyping = false;
            typingValue = '';
            this.options[0].textContent = 'Busque por c√©dula (solo n√∫meros, m√°x. 10)';
            restoreInitialOptions(this.value);
          } else if (e.key === 'ArrowDown' || e.key === 'ArrowUp') {
            // Allow dropdown navigation
            if (!isTyping) {
              restoreInitialOptions(this.value);
            }
          }
        });

        // Handle regular selection
        patientSelect.addEventListener('change', function () {
          const selected = this.selectedOptions[0];
          lastSelectedValue = this.value; // Store the selected value
          if (selected && selected.value) {
            // Patient selected - show form with data
            sectionPatientFields.style.display = 'block';
            firstNameInput.value = selected.dataset.first;
            lastNameInput.value = selected.dataset.last;
            dniInput.value = selected.dataset.dni;
            phoneInput.value = selected.dataset.phone;
            emailInput.value = selected.dataset.email;
            ageInput.value = selected.dataset.age;
            sexSelect.value = selected.dataset.sex;

            // Make fields readonly
            [firstNameInput, lastNameInput, dniInput, phoneInput, emailInput, ageInput, sexSelect]
              .forEach(el => {
                el.setAttribute('readonly', true);
                el.disabled = true;
                removeErrorMessage(el);
              });

            // Reset typing state
            isTyping = false;
            typingValue = '';
            this.options[0].textContent = 'Busque por c√©dula (solo n√∫meros, m√°x. 10)';
            updatePatientOptions(currentPatients, this.value); // Keep current options with selected value
          } else {
            // No patient selected - hide form
            sectionPatientFields.style.display = 'none';
            isTyping = false;
            typingValue = '';
            this.options[0].textContent = 'Busque por c√©dula (solo n√∫meros, m√°x. 10)';
            restoreInitialOptions();
          }
        });

        // Handle focus - show all patients if not typing
        patientSelect.addEventListener('focus', function () {
          if (!isTyping) {
            restoreInitialOptions(lastSelectedValue); // Show all patients, preserve selection
          } else if (typingValue) {
            this.options[0].textContent = `Buscando: ${typingValue}`;
          }
        });

        // Handle click - show all patients if not typing
        patientSelect.addEventListener('click', function () {
          if (!isTyping && !typingValue) {
            restoreInitialOptions(lastSelectedValue); // Show all patients, preserve selection
            this.options[0].textContent = 'Busque por c√©dula (solo n√∫meros, m√°x. 10)';
          }
        });

        // Handle blur - maintain typing state or reset
        patientSelect.addEventListener('blur', function () {
          if (!this.value && !typingValue) {
            isTyping = false;
            this.options[0].textContent = 'Busque por c√©dula (solo n√∫meros, m√°x. 10)';
            restoreInitialOptions();
          } else if (typingValue) {
            this.options[0].textContent = `Buscando: ${typingValue}`;
          }
        });

        // Clear form for new patient
        btnAddNew.addEventListener('click', function () {
          sectionPatientFields.style.display = 'block';
          [firstNameInput, lastNameInput, dniInput, phoneInput, emailInput, ageInput, sexSelect]
            .forEach(el => {
              el.value = '';
              el.removeAttribute('readonly');
              el.disabled = false;
              removeErrorMessage(el);
            });

          // Clear patient selection and reset typing state
          patientSelect.value = '';
          lastSelectedValue = '';
          isTyping = false;
          typingValue = '';
          patientSelect.options[0].textContent = 'Busque por c√©dula (solo n√∫meros, m√°x. 10)';
          restoreInitialOptions();
        });

        // Initialize with sorted patients (most recent first)
        restoreInitialOptions();

        // Rest of the existing code for validation, image handling, and form submission remains unchanged
        function createErrorMessage(input, message, isWarning = false) {
          removeErrorMessage(input);
          const errorDiv = document.createElement('div');
          errorDiv.className = isWarning ? 'warning-message' : 'error-message';
          errorDiv.textContent = message;
          input.parentNode.appendChild(errorDiv);
          input.classList.add(isWarning ? 'warning' : 'error');
        }

        function removeErrorMessage(input) {
          const errorMsg = input.parentNode.querySelector('.error-message, .warning-message');
          if (errorMsg) errorMsg.remove();
          input.classList.remove('error', 'warning');
        }

        function validateFullName(value) {
          const trimmedValue = value.trim();
          if (!trimmedValue) return "El campo est√° vac√≠o, por favor rell√©nelo.";
          if (trimmedValue.length < 3) return "El nombre o apellido debe tener al menos 3 caracteres.";
          if (trimmedValue.length > 50) return "El nombre o apellido no puede tener m√°s de 50 caracteres.";
          const nameRegex = /^[a-zA-Z√°√©√≠√≥√∫√Å√â√ç√ì√ö√±√ë\s]+$/;
          if (!nameRegex.test(trimmedValue)) return "Solo puede contener letras, incluyendo letras especiales como la √ë o tilde.";
          return null;
        }

        function validateDni(value) {
          const trimmedValue = value.trim();
          if (!trimmedValue) return {message: "El campo est√° vac√≠o, por favor rell√©nelo.", isWarning: false};
          if (trimmedValue.length !== 10) return {
            message: "La c√©dula debe contener exactamente 10 d√≠gitos.",
            isWarning: false
          };
          if (!/^\d+$/.test(trimmedValue)) return {message: "La c√©dula debe contener solo n√∫meros.", isWarning: false};
          const coeficientes = [2, 1, 2, 1, 2, 1, 2, 1, 2];
          let total = 0;
          for (let i = 0; i < 9; i++) {
            let valor = parseInt(trimmedValue[i]) * coeficientes[i];
            if (valor > 9) valor -= 9;
            total += valor;
          }
          const digitoVerificador = (total % 10) === 0 ? 0 : 10 - (total % 10);
          if (digitoVerificador !== parseInt(trimmedValue[9])) return {
            message: "La c√©dula ingresada no es v√°lida.",
            isWarning: false
          };
          return null;
        }

        function validateEmail(value) {
          const trimmedValue = value.trim();
          if (!trimmedValue) return "El campo est√° vac√≠o, por favor rell√©nelo.";
          if (trimmedValue.length > 254) return "El correo electr√≥nico no puede tener m√°s de 254 caracteres.";
          const emailRegex = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
          if (!emailRegex.test(trimmedValue)) return "Ingrese un correo electr√≥nico v√°lido.";
          return null;
        }

        function validatePhone(value) {
          const trimmedValue = value.trim();
          if (!trimmedValue) return "El campo est√° vac√≠o, por favor rell√©nelo.";
          if (!/^(\+593\s\d{2}\s\d{3}\s\d{4}|0\d{9})$/.test(trimmedValue)) return "Ingrese un n√∫mero v√°lido (formato: +593 99 999 9999 o 0999999999)";
          return null;
        }

        function validateAge(value) {
          if (!value) return "El campo est√° vac√≠o, por favor rell√©nelo.";
          const age = parseInt(value);
          if (isNaN(age) || age < 0 || age > 120) return "Ingrese una edad v√°lida entre 0 y 120 a√±os.";
          return null;
        }

        function validateImage(file) {
          if (!file) return "Por favor seleccione una imagen para analizar.";
          const validTypes = ['image/jpeg', 'image/png', 'image/jpg'];
          if (!validTypes.includes(file.type)) return "El archivo debe ser una imagen (JPG, JPEG o PNG).";
          const maxSize = 5 * 1024 * 1024; // 5MB
          if (file.size > maxSize) return "La imagen no debe exceder los 5MB.";
          return null;
        }

        uploadArea.addEventListener('click', () => fileInput.click());
        uploadArea.addEventListener('dragover', e => {
          e.preventDefault();
          uploadArea.style.borderColor = '#007bff';
          uploadArea.style.backgroundColor = '#f8fbff';
        });
        uploadArea.addEventListener('dragleave', () => {
          uploadArea.style.borderColor = '#ccc';
          uploadArea.style.backgroundColor = '';
        });
        uploadArea.addEventListener('drop', e => {
          e.preventDefault();
          uploadArea.style.borderColor = '#ccc';
          uploadArea.style.backgroundColor = '';
          if (e.dataTransfer.files.length) {
            const file = e.dataTransfer.files[0];
            const error = validateImage(file);
            if (error) {
              createErrorMessage(fileInput, error);
            } else {
              removeErrorMessage(fileInput);
              fileInput.files = e.dataTransfer.files;
              previewImage(file);
            }
          }
        });

        fileInput.addEventListener('change', () => {
          if (fileInput.files.length) {
            const file = fileInput.files[0];
            const error = validateImage(file);
            if (error) {
              createErrorMessage(fileInput, error);
            } else {
              removeErrorMessage(fileInput);
              previewImage(file);
            }
          }
        });

        function previewImage(file) {
          const reader = new FileReader();
          reader.onload = e => {
            imagePreview.src = e.target.result;
            imagePreview.style.display = 'block';
          };
          reader.readAsDataURL(file);
        }

        uploadForm.addEventListener('submit', function (e) {
          e.preventDefault();
          let hasErrors = false;

          errorAlert.style.display = 'none';

          if (!patientSelect.value) {
            const firstNameError = validateFullName(firstNameInput.value);
            if (firstNameError) {
              createErrorMessage(firstNameInput, firstNameError);
              hasErrors = true;
            }

            const lastNameError = validateFullName(lastNameInput.value);
            if (lastNameError) {
              createErrorMessage(lastNameInput, lastNameError);
              hasErrors = true;
            }

            const dniResult = validateDni(dniInput.value);
            if (dniResult) {
              createErrorMessage(dniInput, dniResult.message, dniResult.isWarning);
              if (!dniResult.isWarning) hasErrors = true;
            }

            const phoneError = validatePhone(phoneInput.value);
            if (phoneError) {
              createErrorMessage(phoneInput, phoneError);
              hasErrors = true;
            }

            const emailError = validateEmail(emailInput.value);
            if (emailError) {
              createErrorMessage(emailInput, emailError);
              hasErrors = true;
            }

            const ageError = validateAge(ageInput.value);
            if (ageError) {
              createErrorMessage(ageInput, ageError);
              hasErrors = true;
            }
          }

          const imageError = validateImage(fileInput.files[0]);
          if (imageError) {
            createErrorMessage(fileInput, imageError);
            hasErrors = true;
          }

          if (!siteSelect.value) {
            createErrorMessage(siteSelect, "Por favor seleccione la localizaci√≥n anat√≥mica.");
            hasErrors = true;
          }

          if (hasErrors) return;

          loadingOverlay.style.display = 'flex';
          const formData = new FormData();

          if (patientSelect.value) {
            formData.append('patient', patientSelect.value);
          } else {
            formData.append('first_name', firstNameInput.value);
            formData.append('last_name', lastNameInput.value);
            formData.append('dni', dniInput.value);
            formData.append('phone', phoneInput.value);
            formData.append('email', emailInput.value);
            formData.append('age_approx', ageInput.value);
            formData.append('sex', sexSelect.value);
          }

          formData.append('image', fileInput.files[0]);
          formData.append('anatom_site_general', siteSelect.value);
          formData.append('csrfmiddlewaretoken', csrfToken);

          fetch("/dermatology/upload/", {
            method: 'POST',
            body: formData
          })
            .then(res => {
              if (!res.ok) {
                if (res.headers.get('content-type')?.includes('application/json')) {
                  return res.json().then(data => {
                    throw new Error(data.error || 'Error desconocido');
                  });
                }
                throw new Error(`Error del servidor: ${res.status} ${res.statusText}`);
              }
              return res.json();
            })
            .then(data => {
              if (data.success && data.redirect_url) {
                window.location.href = data.redirect_url;
              } else {
                throw new Error(data.error || 'Error desconocido');
              }
            })
            .catch(err => {
              errorAlert.textContent = err.message;
              errorAlert.style.display = 'block';
              loadingOverlay.style.display = 'none';
            });
        });
      });
    </script>
  {% endblock %}
{% endblock %}