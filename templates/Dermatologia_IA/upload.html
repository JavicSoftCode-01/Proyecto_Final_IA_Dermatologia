{% extends "components/base.html" %}
{% load static %}

{% block title %}
  {{ page_title }}
{% endblock %}

{% block extra_css %}
  <link rel="stylesheet" href="{% static 'css/upload.css' %}" />
{% endblock %}

{% block content %}
  <div class="container mt-4">
    <div class="card p-4">
      <h1 class="text-center mb-4">{{ upload_section.title }}</h1>

      <form
        id="uploadForm"
        enctype="multipart/form-data"
        method="post"
        data-search-url="{% url 'dermatology:search_patients' %}"
        data-submit-url="{% url 'dermatology:upload_image' %}"
      >
        {% csrf_token %}

        <div id="section-select-patient" class="mb-4">
          <label class="form-label">{{ upload_section.patient_search.label }}</label>
          <div class="patient-select-container">
            <select
              class="form-select"
              name="patient"
              id="patient_select"
              aria-label="Buscar paciente por cÃ©dula"
            >
              <option value="">
                {{ upload_section.patient_search.select_placeholder }}
              </option>
              {% for patient in patients %}
                <option
                  value="{{ patient.id }}"
                  data-first="{{ patient.first_name }}"
                  data-last="{{ patient.last_name }}"
                  data-dni="{{ patient.dni }}"
                  data-phone="{{ patient.phone|default:'' }}"
                  data-email="{{ patient.email|default:'' }}"
                  data-age="{{ patient.age_approx }}"
                  data-sex="{{ patient.sex }}"
                >
                  {{ patient.dni }} - {{ patient.first_name }} {{ patient.last_name }}
                </option>
              {% endfor %}
            </select>
            <div class="typing-hint">
              {{ upload_section.patient_search.typing_hint }}
            </div>
          </div>
          <div class="mt-3">
            <button type="button" class="btn btn-success" id="btn-add-new">
              {{ upload_section.new_patient.button_text }}
            </button>
          </div>
        </div>

        <div id="section-upload">
          <div class="mb-4">
            <label class="form-label">{{ upload_section.image_upload.title }}</label>
            <div class="upload-area" id="uploadArea">
              <i class="bi bi-cloud-arrow-up fs-1"></i>
              <h4 class="mt-3">{{ upload_section.image_upload.instructions }}</h4>
              <p class="text-muted">{{ upload_section.image_upload.formats }}</p>
              <input
                type="file"
                id="fileInput"
                name="image"
                accept="image/*"
                style="display: none"
                required
              />
              <img
                id="imagePreview"
                class="image-preview"
                src="#"
                alt="{{ upload_section.image_upload.preview_alt }}"
                style="display: none"
              />
            </div>
            <div
              id="fileError"
              class="alert alert-danger mt-2"
              style="display: none"
            ></div>
          </div>

          <div class="mb-4">
            <label class="form-label">{{ upload_section.location.label }}</label>
            <select
              id="site_select"
              name="anatom_site_general"
              class="form-select"
              required
            >
              <option value="">{{ upload_section.location.placeholder }}</option>
              {% for code, display in form.anatom_site_general.field.choices %}
                <option value="{{ code }}">{{ display }}</option>
              {% endfor %}
            </select>
            <div
              id="siteError"
              class="alert alert-danger mt-2"
              style="display: none"
            ></div>
          </div>
        </div>

        <div id="section-patient-fields" class="patient-form">
          <h4 class="mb-3">{{ upload_section.new_patient.title }}</h4>
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="first_name" class="form-label">
                {{ upload_section.new_patient.labels.first_name }}
              </label>
              <input
                type="text"
                id="first_name"
                name="first_name"
                class="form-control mb-2"
                placeholder="{{ upload_section.new_patient.labels.first_name }}"
              />
            </div>
            <div class="col-md-6 mb-3">
              <label for="last_name" class="form-label">
                {{ upload_section.new_patient.labels.last_name }}
              </label>
              <input
                type="text"
                id="last_name"
                name="last_name"
                class="form-control mb-2"
                placeholder="{{ upload_section.new_patient.labels.last_name }}"
              />
            </div>
          </div>
          <div class="row">
            <div class="col-md-4 mb-3">
              <label for="dni" class="form-label">
                {{ upload_section.new_patient.labels.dni }}
              </label>
              <input
                type="text"
                id="dni"
                name="dni"
                class="form-control mb-2"
                placeholder="{{ upload_section.new_patient.labels.dni }}"
              />
            </div>
            <div class="col-md-4 mb-3">
              <label for="phone" class="form-label">
                {{ upload_section.new_patient.labels.phone }}
              </label>
              <input
                type="text"
                id="phone"
                name="phone"
                class="form-control mb-2"
                placeholder="{{ upload_section.new_patient.labels.phone }}"
              />
            </div>
            <div class="col-md-4 mb-3">
              <label for="email" class="form-label">
                {{ upload_section.new_patient.labels.email }}
              </label>
              <input
                type="email"
                id="email"
                name="email"
                class="form-control mb-2"
                placeholder="{{ upload_section.new_patient.labels.email }}"
              />
            </div>
          </div>
          <div class="row mb-3">
            <div class="col-md-4">
              <label for="age_approx" class="form-label">
                {{ upload_section.new_patient.labels.age_approx }}
              </label>
              <input
                type="number"
                id="age_approx"
                name="age_approx"
                class="form-control mb-2"
                min="0"
                max="120"
              />
            </div>
            <div class="col-md-4">
              <label for="sex" class="form-label">
                {{ upload_section.new_patient.labels.sex }}
              </label>
              <select id="sex" name="sex" class="form-select mb-2">
                <option value="">
                  {{ upload_section.new_patient.sex_placeholder }}
                </option>
                {% for value, display_name in sex_choices %}
                  <option value="{{ value }}">{{ display_name }}</option>
                {% endfor %}
              </select>
            </div>
          </div>
        </div>

        <div
          id="errorAlert"
          class="alert alert-danger"
          style="display: none"
        ></div>

        <div class="d-grid gap-2 mt-4">
          <button
            type="submit"
            class="btn {{ buttons.submit.class }}"
            id="analyzeBtn"
          >
            {{ buttons.submit.text }}
          </button>
        </div>
      </form>
    </div>
  </div>

  <div class="loading-overlay" id="loadingOverlay" style="display: none">
    <div class="loading-container">
      <div class="spinner-border text-light" role="status">
        <span class="visually-hidden">{{ loading.spinner_alt }}</span>
      </div>
      <div class="loading-text">
        <p>{{ loading.message }}</p>
        <p class="small text-muted">{{ loading.submessage }}</p>
      </div>
    </div>
  </div>
{% endblock %}

{% block extra_js %}
  <script src="{% static 'js/upload.js' %}"></script>
  <script>
    document.addEventListener("DOMContentLoaded", function () {
      // Pasar textos de JS desde el contexto de Django
      const JS_TEXTS = {
        searchingPrefix: "{{ js_texts.searching_prefix|escapejs }}",
        searchPlaceholderDefault: "{{ js_texts.search_placeholder_default|escapejs }}",
        errorSearchingPatients: "{{ js_texts.error_searching_patients|escapejs }}",
        validation: {
          emptyField: "{{ js_texts.validation_errors.empty_field|escapejs }}",
          nameMinLength: "{{ js_texts.validation_errors.name_min_length|escapejs }}",
          nameMaxLength: "{{ js_texts.validation_errors.name_max_length|escapejs }}",
          nameRegex: "{{ js_texts.validation_errors.name_regex|escapejs }}",
          dniExactLength: "{{ js_texts.validation_errors.dni_exact_length|escapejs }}",
          dniNumeric: "{{ js_texts.validation_errors.dni_numeric|escapejs }}",
          dniInvalid: "{{ js_texts.validation_errors.dni_invalid|escapejs }}",
          emailMaxLength: "{{ js_texts.validation_errors.email_max_length|escapejs }}",
          emailInvalid: "{{ js_texts.validation_errors.email_invalid|escapejs }}",
          phoneInvalidFormat: "{{ js_texts.validation_errors.phone_invalid_format|escapejs }}",
          ageInvalid: "{{ js_texts.validation_errors.age_invalid|escapejs }}",
          imageRequired: "{{ js_texts.validation_errors.image_required|escapejs }}",
          imageInvalidType: "{{ js_texts.validation_errors.image_invalid_type|escapejs }}",
          imageMaxSize: "{{ js_texts.validation_errors.image_max_size|escapejs }}",
          siteRequired: "{{ js_texts.validation_errors.site_required|escapejs }}",
        },
        generalErrors: {
          formErrors: "{{ error_messages_general.form_errors|escapejs }}",
          serverError: "{{ error_messages_general.server_error|escapejs }}",
        },
      };

      // Inicializar el manager de upload
      initializeUpload(JS_TEXTS);
    });
  </script>
{% endblock %}
