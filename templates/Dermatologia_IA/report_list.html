{% extends 'components/base.html' %}
{% load static %}

{% block title %}
  {{ page_title|default:"Lista de Reportes" }}
{% endblock %}

{% block extra_css %}
  <link rel="stylesheet" href="{% static 'css/report_list.css' %}"/>
{% endblock %}

{% block content %}
  <div class="reports-container">
    <!-- Header de la página -->
    <div class="reports-header">
      <h1>{{ header_title|default:"Mis Reportes de Análisis" }}</h1>
      <p>Visualiza y gestiona todos tus análisis dermatológicos realizados</p>
    </div>

    <!-- Contenido principal -->
    {% if reports %}
      <!-- Grid de reportes -->
      <div class="reports-grid">
        {% for report in reports %}
          <div class="report-card" data-report-id="{{ report.id }}">
            <div class="report-header">
              <div class="report-icon">
                <i class="fas fa-microscope"></i>
              </div>
              <div class="report-condition">
                Reporte {{ report.condition|default:"Sin condición especificada" }} <i
                      class="fas fa-hashtag fa-lg"></i> {{ report.id }}
              </div>
            </div>

            <!-- Información del paciente -->
            <div class="patient-info">
              <h4><i class="fas fa-user fa-lg"></i> Información del Paciente</h4>
              <div class="patient-details">
                <div class="patient-detail">
                  <i class="fas fa-user"></i>
                  <span>
                    <strong>Nombre:</strong>
                    <span data-patient-name>
                      {% if report.patient.first_name or report.patient.last_name %}
                        {{ report.patient.first_name|default:"" }} {{ report.patient.last_name|default:"" }}
                      {% else %}
                        N/A
                      {% endif %}
                    </span>
                  </span>
                </div>
                <div class="patient-detail">
                  <i class="fas fa-id-card"></i>
                  <span><strong>CI:</strong> {{ report.patient.dni|default:"N/A" }}</span>
                </div>
                <div class="patient-detail">
                  <i class="fas fa-user-clock"></i>
                  <span><strong>Edad:</strong> {{ report.patient.age_approx|default:"N/A" }}</span>
                </div>
                <div class="patient-detail">
                  <i class="fas fa-venus-mars"></i>
                  <span><strong>Sexo:</strong> {{ report.patient.get_sex_display|default:"N/A" }}</span>
                </div>
                <!-- Email oculto para JavaScript -->
                <div class="patient-detail" style="display: none">
                  <span data-patient-email>{{ report.patient.email|default:"" }}</span>
                </div>
              </div>
            </div>

            <!-- Información de la consulta -->
            <div class="consultation-info">
              <div class="consultation-detail">
                <i class="fas fa-search"></i>
                <span>
                  <strong>Zona Afectada:</strong>
                  {% if report.anatom_site_general %}
                    {{ report.get_anatom_site_general_display }}
                  {% else %}
                    N/A
                  {% endif %}
                </span>
              </div>
              <div class="consultation-detail">
                <i class="fas fa-calendar-alt"></i>
                <span><strong>Fecha y Hora:</strong> {{ report.created_at|date:"d \\d\\e F, Y - h:i A" }}</span>
              </div>
            </div>

            <!-- Botones de acción -->
            <div class="report-actions">
              <a href="{% url 'dermatology:report_detail' report.id %}" class="btn-action btn-view">
                <i class="fas fa-eye fa-lg"></i>
                Detalles
              </a>
              <a href="{% url 'dermatology:generate_report' report.id %}" class="btn-action btn-pdf">
                <i class="fas fa-file-pdf fa-lg"></i>
                PDF
              </a>
              <button type="button"
                      class="btn-action btn-email"
                      data-bs-toggle="modal"
                      data-bs-target="#emailModal{{ report.id }}"
                      data-report-id="{{ report.id }}"
                      data-patient-name="
                              {% if report.patient.first_name or report.patient.last_name %}{{ report.patient.first_name|default:'' }}
                                {{ report.patient.last_name|default:'' }}{% else %}Paciente desconocido{% endif %}"
                      data-patient-email="{{ report.patient.email|default:'' }}"
                      data-condition="{{ report.condition|default:'Sin condición especificada' }}">
                <i class="fas fa-envelope fa-lg"></i>
                Email
              </button>
            </div>
          </div>
        {% endfor %}
      </div>

      <!-- Modales para envío por email -->
      {% for report in reports %}
        <div class="modal fade"
             id="emailModal{{ report.id }}"
             tabindex="-1"
             aria-labelledby="emailModalLabel{{ report.id }}"
             aria-hidden="true">
          <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="emailModalLabel{{ report.id }}">
                  <i class="fas fa-envelope me-2"></i>
                  Enviar Reporte por Email
                </h5>
                <button type="button"
                        class="btn-close"
                        data-bs-dismiss="modal"
                        aria-label="Cerrar"></button>
              </div>

              <form action="{% url 'dermatology:send_report_email' image_id=report.id %}"
                    method="post"
                    class="email-form">
                {% csrf_token %}
                <div class="modal-body">
                  <div class="mb-3">
                    <label for="email{{ report.id }}" class="form-label">
                      <i class="fas fa-at me-1"></i>
                      Email destinatario:
                    </label>
                    <input value="{{ report.patient.email|default:'' }}"
                           type="email"
                           class="form-control"
                           name="email"
                           id="email{{ report.id }}"
                           required
                           placeholder="correo@ejemplo.com"
                           autocomplete="email"/>
                    <div class="invalid-feedback"></div>
                  </div>

                  <p class="small text-muted mb-0">
                    <i class="fas fa-shield-alt me-1"></i>
                    El reporte incluye información confidencial del paciente.
                    Asegúrese de enviar a la dirección correcta.
                  </p>
                </div>

                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>
                    Cancelar
                  </button>
                  <button type="submit" class="btn btn-primary">
                    <i class="fas fa-paper-plane me-1"></i>
                    Enviar Reporte
                  </button>
                </div>
              </form>
            </div>
          </div>
        </div>
      {% endfor %}

      <!-- Paginación -->
      {% if is_paginated %}
        <div class="pagination-container">
          <nav aria-label="Navegación de reportes">
            <ul class="pagination">
              {% if page_obj.has_previous %}
                <li class="page-item">
                  <a class="page-link" href="?page=1">« Primera</a>
                </li>
                <li class="page-item">
                  <a class="page-link" href="?page={{ page_obj.previous_page_number }}">Anterior</a>
                </li>
              {% endif %}

              <li class="page-item active">
                <span class="page-link">
                  Página {{ page_obj.number }} de {{ page_obj.paginator.num_pages }}
                </span>
              </li>

              {% if page_obj.has_next %}
                <li class="page-item">
                  <a class="page-link" href="?page={{ page_obj.next_page_number }}">Siguiente</a>
                </li>
                <li class="page-item">
                  <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}">Última »</a>
                </li>
              {% endif %}
            </ul>
          </nav>
        </div>
      {% endif %}
    {% else %}
      <!-- Estado vacío -->
      <div class="empty-state">
        <i class="fas fa-folder-open empty-icon"></i>
        <h3>No hay reportes disponibles</h3>
        <p>¡Comienza a analizar imágenes para ver tus resultados aquí!</p>
        <a href="{% url 'dermatology:upload_image' %}" class="btn-upload">
          <i class="fas fa-upload"></i>
          Cargar nueva imagen
        </a>
      </div>
    {% endif %}
  </div>
{% endblock %}

{% block extra_js %}
  <script src="{% static 'js/report_list.js' %}"></script>
{% endblock %}
